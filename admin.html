<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração - Controle de Jornada</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- App Scripts -->
    <script src="drivers.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        :root {
            --primary: #0056D2;
            --primary-dark: #0041a3;
            --secondary: #F0F4FF;
            --success: #059669;
            --warning: #D97706;
            --danger: #DC2626;
            --text-main: #111827;
            --text-secondary: #6B7280;
            --bg-body: #F3F4F6;
            --surface: #FFFFFF;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .login-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2.5rem;
            color: white;
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 8px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin: 0 0 30px;
        }

        .input-group {
            text-align: left;
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .input-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 86, 210, 0.3);
        }

        .error-msg {
            background: #FEE2E2;
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 16px;
            display: none;
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
        }

        .admin-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .admin-header h1 {
            margin: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .admin-content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.blue {
            background: #DBEAFE;
            color: var(--primary);
        }

        .stat-icon.green {
            background: #D1FAE5;
            color: var(--success);
        }

        .stat-icon.yellow {
            background: #FEF3C7;
            color: var(--warning);
        }

        .stat-icon.red {
            background: #FEE2E2;
            color: var(--danger);
        }

        .stat-info h3 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .stat-info p {
            margin: 4px 0 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Companies Grid */
        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 24px;
        }

        @media (max-width: 1000px) {
            .companies-grid {
                grid-template-columns: 1fr;
            }
        }

        .company-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .company-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #E5E7EB;
        }

        .company-header.mep {
            background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
            color: white;
        }

        .company-header.mantovani {
            background: linear-gradient(135deg, #0056D2 0%, #0041a3 100%);
            color: white;
        }

        .company-name {
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .company-stats {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Driver Table */
        .driver-table {
            width: 100%;
            border-collapse: collapse;
        }

        .driver-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            background: #F9FAFB;
            border-bottom: 1px solid #E5E7EB;
        }

        .driver-table td {
            padding: 12px 16px;
            font-size: 0.85rem;
            border-bottom: 1px solid #F3F4F6;
        }

        .driver-table tr:hover {
            background: #F9FAFB;
        }

        .driver-name {
            font-weight: 600;
            color: var(--text-main);
        }

        .driver-cpf {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .password-badge {
            background: #F3F4F6;
            padding: 4px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.completed {
            background: #D1FAE5;
            color: var(--success);
        }

        .status-badge.pending {
            background: #FEF3C7;
            color: var(--warning);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.7rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .btn-view {
            background: var(--secondary);
            color: var(--primary);
        }

        .btn-view:hover {
            background: #DBEAFE;
        }

        .btn-edit {
            background: #FEF3C7;
            color: #92400E;
        }

        .btn-edit:hover {
            background: #FDE68A;
        }

        .btn-delete {
            background: #FEE2E2;
            color: #DC2626;
        }

        .btn-delete:hover {
            background: #FECACA;
        }

        .btn-toggle {
            background: #F3F4F6;
            color: #6B7280;
        }

        .btn-toggle:hover {
            background: #E5E7EB;
        }

        .btn-reset {
            background: #FFEDD5;
            color: #C2410C;
        }

        .btn-reset:hover {
            background: #FED7AA;
        }

        .actions-cell {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .driver-inactive {
            opacity: 0.5;
        }

        .inactive-badge {
            background: #9CA3AF;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            margin-left: 6px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9CA3AF;
        }

        .modal-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .modal-body label {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 6px;
        }

        .modal-body input,
        .modal-body select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .modal-body input:focus,
        .modal-body select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-footer .btn {
            width: auto;
        }

        .btn-google {
            background: white;
            color: #374151;
            border: 1px solid #D1D5DB;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-weight: 500;
        }

        .btn-google:hover {
            background: #F9FAFB;
            border-color: #9CA3AF;
        }

        .btn-google img {
            width: 18px;
            height: 18px;
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            color: #6B7280;
            font-size: 0.8rem;
            margin: 15px 0;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #E5E7EB;
        }

        .divider:not(:empty)::before {
            margin-right: .5em;
        }

        .divider:not(:empty)::after {
            margin-left: .5em;
        }

        /* Add Driver */
        .add-driver-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .add-driver-section h3 {
            margin: 0 0 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .add-form input,
        .add-form select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .add-form input:focus,
        .add-form select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-add {
            background: var(--success);
            color: white;
            grid-column: span 2;
        }

        @media (max-width: 600px) {
            .btn-add {
                grid-column: span 1;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>

<body>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-icon">
                <i class="ph ph-shield-check"></i>
            </div>
            <h1 class="login-title">Área Administrativa</h1>
            <p class="login-subtitle">Digite a senha de administrador</p>

            <form onsubmit="attemptLogin(event)">
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="adminPassword" placeholder="Digite a senha..." autocomplete="off">
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="ph ph-sign-in"></i> Entrar
                </button>
            </form>

            <div class="divider">ou</div>

            <button type="button" class="btn btn-google" onclick="loginWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google Logo">
                Entrar com Google
            </button>

            <div class="error-msg" id="errorMsg">
                <i class="ph ph-warning"></i> Senha incorreta. Tente novamente.
            </div>

            <a href="login.html"
                style="display: inline-flex; align-items: center; gap: 6px; margin-top: 20px; color: #6B7280; text-decoration: none; font-size: 0.85rem;">
                <i class="ph ph-arrow-left"></i> Voltar para Login de Motorista
            </a>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <header class="admin-header">
            <h1><i class="ph ph-gauge"></i> Painel Administrativo</h1>
            <button class="btn-logout" onclick="logout()">
                <i class="ph ph-sign-out"></i> Sair
            </button>
        </header>

        <div class="admin-content">
            <!-- Stats -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon blue"><i class="ph ph-users"></i></div>
                    <div class="stat-info">
                        <h3 id="statTotal">0</h3>
                        <p>Motoristas Cadastrados</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green"><i class="ph ph-check-circle"></i></div>
                    <div class="stat-info">
                        <h3 id="statCompleted">0</h3>
                        <p>Treinamentos Concluídos</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon yellow"><i class="ph ph-clock"></i></div>
                    <div class="stat-info">
                        <h3 id="statPending">0</h3>
                        <p>Pendentes</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon red"><i class="ph ph-certificate"></i></div>
                    <div class="stat-info">
                        <h3 id="statCertificates">0</h3>
                        <p>Certificados Emitidos</p>
                    </div>
                </div>
            </div>

            <!-- Companies -->
            <div class="companies-grid">
                <!-- Empresa A -->
                <div class="company-card">
                    <div class="company-header mep">
                        <span class="company-name"><i class="ph ph-truck"></i> Empresa A Transportes</span>
                        <span class="company-stats" id="mepStats">0/0 treinados</span>
                    </div>
                    <table class="driver-table">
                        <thead>
                            <tr>
                                <th>Motorista</th>
                                <th>Operação</th>
                                <th>Coação</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="mepDrivers"></tbody>
                    </table>
                </div>

                <!-- Empresa B -->
                <div class="company-card">
                    <div class="company-header mantovani">
                        <span class="company-name"><i class="ph ph-truck"></i> Empresa B Transportes</span>
                        <span class="company-stats" id="mantovaniStats">0/0 treinados</span>
                    </div>
                    <table class="driver-table">
                        <thead>
                            <tr>
                                <th>Motorista</th>
                                <th>Operação</th>
                                <th>Coação</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="mantovaniDrivers"></tbody>
                    </table>
                </div>
            </div>

            <!-- Add Driver -->
            <div class="add-driver-section">
                <h3><i class="ph ph-user-plus"></i> Cadastrar Novo Motorista</h3>
                <form class="add-form" onsubmit="addNewDriver(event)">
                    <input type="text" id="newName" placeholder="Nome completo" required>
                    <input type="text" id="newCPF" placeholder="CPF" required>
                    <input type="email" id="newEmail" placeholder="E-mail">
                    <select id="newCompany" required>
                        <option value="">Selecione a empresa</option>
                        <option value="Empresa A">Empresa A Transportes</option>
                        <option value="Empresa B">Empresa B Transportes</option>
                    </select>
                    <input type="text" id="newSenhaOp" placeholder="Senha Operação (4 dígitos)" maxlength="4">
                    <input type="text" id="newSenhaCo" placeholder="Senha Coação (4 dígitos)" maxlength="4">
                    <button type="submit" class="btn btn-add">
                        <i class="ph ph-plus"></i> Cadastrar Motorista
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="ph ph-pencil-simple"></i> Editar Motorista</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div>
                    <label>Nome Completo</label>
                    <input type="text" id="editName" placeholder="Nome do motorista">
                </div>
                <div>
                    <label>CPF</label>
                    <input type="text" id="editCPF" placeholder="000.000.000-00" maxlength="14">
                </div>
                <div>
                    <label>E-mail</label>
                    <input type="email" id="editEmail" placeholder="email@exemplo.com">
                </div>
                <div>
                    <label>Empresa</label>
                    <select id="editCompany">
                        <option value="Empresa A">Empresa A Transportes</option>
                        <option value="Empresa B">Empresa B Transportes</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label>Senha Operação</label>
                        <input type="text" id="editSenhaOp" placeholder="0000" maxlength="4">
                    </div>
                    <div>
                        <label>Senha Coação</label>
                        <input type="text" id="editSenhaCo" placeholder="0000" maxlength="4">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background: #F3F4F6; color: #374151;"
                    onclick="closeEditModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveDriverEdit()"><i class="ph ph-floppy-disk"></i>
                    Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // LOGIN
        // =============================================

        // Configuração de E-mails Autorizados
        const ALLOWED_EMAILS = [
            'admin@empresa-demo.com.br',
            'gestor@empresa-demo.com.br',
            'rh@empresa-demo.com.br'
        ];

        const ALLOWED_DOMAIN = '@empresa-demo.com.br';

        // Validação centralizada de acesso
        function validateAccess(email) {
            if (!email) return false;
            const lowerEmail = email.toLowerCase();
            const isAllowedDomain = lowerEmail.endsWith(ALLOWED_DOMAIN);
            const isAllowedEmail = ALLOWED_EMAILS.includes(lowerEmail);
            return isAllowedDomain || isAllowedEmail;
        }

        // Monitorar estado da autenticação (Persistência)
        document.addEventListener('DOMContentLoaded', () => {
            // Pequeno delay para garantir que o firebase-config carregou
            setTimeout(() => {
                if (typeof auth !== 'undefined') {
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            const email = user.email;
                            if (validateAccess(email)) {
                                console.log('✅ Sessão restaurada para:', email);
                                showAdminPanel();
                                updateWelcomeMessage(email);
                            } else {
                                console.warn('⛔ Acesso negado na restauração de sessão:', email);
                                auth.signOut();
                                // Opcional: mostrar erro na tela de login se necessário
                            }
                        }
                    });
                }
            }, 500);
        });

        function updateWelcomeMessage(email) {
            const header = document.querySelector('.admin-header h1');
            if (header && !header.innerHTML.includes(email)) {
                const iconAndText = '<i class="ph ph-gauge"></i> Painel Administrativo';
                header.innerHTML = `${iconAndText} <span style="font-size:0.8rem; font-weight:normal; margin-left:10px;">(${email})</span>`;
            }
        }

        async function attemptLogin(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;

            // Check password using Firebase Config
            const isValid = await firebaseCheckAdminPassword(password);

            if (isValid) {
                showAdminPanel();
            } else {
                const errorMsg = document.getElementById('errorMsg');
                errorMsg.style.display = 'block';
                errorMsg.innerHTML = '<i class="ph ph-warning"></i> Senha incorreta. Tente novamente.';
                setTimeout(() => errorMsg.style.display = 'none', 3000);
            }
        }

        window.loginWithGoogle = async function () {
            console.log('🔵 Tentando login com Google...');
            if (!auth || !googleProvider) {
                alert('Erro: Autenticação Google não configurada no sistema.');
                return;
            }

            try {
                const result = await auth.signInWithPopup(googleProvider);
                const user = result.user;
                const email = user.email;

                if (validateAccess(email)) {
                    console.log('✅ Acesso autorizado para:', email);
                    showAdminPanel();
                    updateWelcomeMessage(email);
                } else {
                    console.warn('⛔ Acesso negado para:', email);
                    await auth.signOut();

                    const errorMsg = document.getElementById('errorMsg');
                    errorMsg.style.display = 'block';
                    errorMsg.innerHTML = `<i class="ph ph-prohibit"></i> Acesso negado para <strong>${email}</strong>.<br>Apenas e-mails @empresa-demo.com.br são permitidos.`;
                }

            } catch (error) {
                console.error('Login Error:', error);
                const errorMsg = document.getElementById('errorMsg');
                errorMsg.style.display = 'block';
                errorMsg.innerHTML = `<i class="ph ph-warning"></i> Erro no login: ${error.message}`;
            }
        }

        function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadDashboard();
        }

        function logout() {
            if (auth && auth.currentUser) {
                auth.signOut();
            }
            window.location.reload();
        }

        // =============================================
        // DASHBOARD
        // =============================================
        async function loadDashboard() {
            // Initialize Firebase (deprecated call retained but empty)
            await initializeDatabase();

            const stats = await firebaseGetTrainingStats();

            // Update stats cards
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statCompleted').textContent = stats.completed;
            document.getElementById('statPending').textContent = stats.pending;
            document.getElementById('statCertificates').textContent = stats.completed;

            // Update company stats
            const mep = stats.byCompany['Empresa A'];
            const mantovani = stats.byCompany['Empresa B'];
            document.getElementById('mepStats').textContent = `${mep.completed}/${mep.total} treinados`;
            document.getElementById('mantovaniStats').textContent = `${mantovani.completed}/${mantovani.total} treinados`;

            // Load driver tables
            await loadDriverTable('Empresa A', 'mepDrivers');
            await loadDriverTable('Empresa B', 'mantovaniDrivers');
        }

        async function loadDriverTable(company, tableId) {
            const drivers = await firebaseGetDriversByCompany(company);
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';

            for (const driver of drivers) {
                const record = await firebaseGetTrainingRecord(driver.cpf);
                const isCompleted = !!record;
                const isActive = driver.ativo !== false; // Default true

                const row = document.createElement('tr');
                if (!isActive) row.classList.add('driver-inactive');

                row.innerHTML = `
    <td>
        <div class="driver-name">
            ${driver.nome}
            ${!isActive ? '<span class="inactive-badge">INATIVO</span>' : ''}
        </div>
        <div class="driver-cpf">${formatCPF(driver.cpf)}</div>
    </td>
    <td><span class="password-badge">${driver.senhaOperacao}</span></td>
    <td><span class="password-badge">${driver.senhaCoacao}</span></td>
    <td>
        <span class="status-badge ${isCompleted ? 'completed' : 'pending'}">
            <i class="ph ${isCompleted ? 'ph-check' : 'ph-clock'}"></i>
            ${isCompleted ? 'Concluído' : 'Pendente'}
        </span>
    </td>
    <td>
        <div class="actions-cell">
            ${isCompleted ? `<button class="btn-sm btn-view" onclick="viewCertificate('${driver.cpf}')"
                title="Ver Certificado"><i class="ph ph-certificate"></i></button>` : ''}
            ${isCompleted ? `<button class="btn-sm btn-reset"
                onclick="resetTraining('${driver.cpf}', '${driver.nome.replace(/'/g, " \\'")}')"
                title="Resetar Treinamento"><i class="ph ph-arrow-counter-clockwise"></i></button>` : ''}
            <button class="btn-sm btn-edit" onclick="openEditModal('${driver.id}')" title="Editar"><i
                    class="ph ph-pencil-simple"></i></button>
            <button class="btn-sm btn-toggle" onclick="toggleActive('${driver.id}')"
                title="${isActive ? 'Inativar' : 'Ativar'}">
                <i class="ph ${isActive ? 'ph-eye-slash' : 'ph-eye'}"></i>
            </button>
            <button class="btn-sm btn-delete" onclick="confirmDelete('${driver.id}')" title="Excluir"><i
                    class="ph ph-trash"></i></button>
        </div>
    </td>
    `;
                tbody.appendChild(row);
            }
        }

        function formatCPF(cpf) {
            if (!cpf || cpf.length !== 11) return cpf;
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }

        async function viewCertificate(cpf) {
            // Save driver data to view certificate
            const driver = await firebaseFindDriverByCPF(cpf);
            if (driver) {
                localStorage.setItem('viewCertificateDriver', JSON.stringify(driver));
                window.open('certificado.html', '_blank');
            }
        }

        // =============================================
        // ADD DRIVER
        // =============================================
        async function addNewDriver(e) {
            e.preventDefault();
            console.log('🚀 Iniciando cadastro de motorista...');

            const btn = e.submitter || e.target.querySelector('button[type="submit"]');
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> Processando...';

            const newDriver = {
                nome: document.getElementById('newName').value.toUpperCase().trim(),
                cpf: document.getElementById('newCPF').value.replace(/\D/g, ''),
                email: document.getElementById('newEmail').value,
                empresa: document.getElementById('newCompany').value,
                senhaOperacao: document.getElementById('newSenhaOp').value || '0000',
                senhaCoacao: document.getElementById('newSenhaCo').value || '0000',
                cidade: '',
                uf: ''
            };
            console.log('📋 Dados do motorista:', newDriver);

            // Validate CPF
            if (newDriver.cpf.length !== 11) {
                alert('CPF deve ter 11 dígitos');
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
                return;
            }

            // Validate Name
            if (newDriver.nome.length < 3) {
                alert('Nome muito curto');
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
                return;
            }

            try {
                // Check if exists in Firebase by CPF
                console.log('🔍 Verificando CPF no Firebase...');
                const existingCPF = await firebaseFindDriverByCPF(newDriver.cpf);
                if (existingCPF) {
                    alert('Já existe um motorista com este CPF');
                    return;
                }

                // Check if exists in Firebase by Name
                console.log('🔍 Verificando Nome no Firebase...');
                const existingName = await firebaseFindDriverByName(newDriver.nome);
                if (existingName) {
                    alert(`Já existe um motorista com o nome "${newDriver.nome}" cadastrado.`);
                    return;
                }

                // Add driver to Firebase (única fonte da verdade)
                console.log('💾 Salvando no Firebase...');
                await firebaseAddDriver(newDriver);

                // Clear form
                e.target.reset();

                // Reload dashboard
                await loadDashboard();

                alert('Motorista cadastrado com sucesso!');
            } catch (error) {
                console.error('❌ Erro ao cadastrar:', error);
                alert('Erro ao cadastrar motorista: ' + error.message);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalBtnContent;
                }
            }
        }

        // =============================================
        // EDIT / DELETE / TOGGLE
        // =============================================
        let currentEditDriver = null;

        async function openEditModal(id) {
            const drivers = await firebaseGetAllDrivers();
            currentEditDriver = drivers.find(d => d.id == id);
            if (!currentEditDriver) return;

            document.getElementById('editId').value = currentEditDriver.id;
            document.getElementById('editName').value = currentEditDriver.nome;
            document.getElementById('editCPF').value = formatCPF(currentEditDriver.cpf);
            document.getElementById('editEmail').value = currentEditDriver.email || '';
            document.getElementById('editCompany').value = currentEditDriver.empresa;
            document.getElementById('editSenhaOp').value = currentEditDriver.senhaOperacao;
            document.getElementById('editSenhaCo').value = currentEditDriver.senhaCoacao;

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditDriver = null;
        }

        async function saveDriverEdit() {
            const id = parseInt(document.getElementById('editId').value);
            const updates = {
                nome: document.getElementById('editName').value.toUpperCase(),
                cpf: document.getElementById('editCPF').value.replace(/\D/g, ''),
                email: document.getElementById('editEmail').value,
                empresa: document.getElementById('editCompany').value,
                senhaOperacao: document.getElementById('editSenhaOp').value || '0000',
                senhaCoacao: document.getElementById('editSenhaCo').value || '0000'
            };

            if (updates.cpf.length !== 11) {
                alert('CPF inválido');
                return;
            }

            await firebaseUpdateDriver(id, updates);
            closeEditModal();
            await loadDashboard();
            alert('Motorista atualizado!');
        }

        async function toggleActive(id) {
            const driver = await firebaseToggleDriverActive(id);
            if (driver) {
                await loadDashboard();
            }
        }

        async function confirmDelete(id) {
            const drivers = await firebaseGetAllDrivers();
            const driver = drivers.find(d => d.id == id);
            if (!driver) return;

            if (confirm(`Tem certeza que deseja EXCLUIR permanentemente o motorista:\n\n${driver.nome}?\n\nEsta ação não pode
    ser desfeita!`)) {
                await firebaseDeleteDriver(id);
                await loadDashboard();
                alert('Motorista excluído.');
            }
        }

        async function resetTraining(cpf, nome) {
            if (!confirm(`Deseja RESETAR o treinamento do motorista:\n\n${nome}?\n\nO motorista precisará refazer o treinamento
    completo.`)) {
                return;
            }

            try {
                // Show loading state
                const btn = event.target.closest('button');
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i>';
                }

                // Reset in Firebase (única fonte da verdade)
                const success = await firebaseResetTrainingRecord(cpf);

                if (success) {
                    // Wait a moment for Firebase to propagate the change
                    await new Promise(resolve => setTimeout(resolve, 500));

                    alert('✅ Treinamento resetado com sucesso!\n\nO motorista precisará fazer o treinamento novamente.');

                    // Force reload all stats
                    await loadDashboard();
                } else {
                    alert('Erro ao resetar treinamento.');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="ph ph-arrow-counter-clockwise"></i>';
                    }
                }
            } catch (error) {
                console.error('Erro ao resetar:', error);
                alert('Erro ao resetar treinamento.');
            }
        }
    </script>
</body>

</html>


